- 怎样实现主机到主机的通信服务的
	- 用于构造网络层分组交付的方法，即数据报模式和虚电路模式
- 网络层的功能
	- 转发功能：涉及分组在单一的路由器中从一条入链路到一条出链路的传送
	- 路由选择功能：一个网络的所有路由器，它们经路由选择协议共同交互，以决定分组从源到目的结点所采用的路径
- 路由选择算法：发送方到接收方的好的路径（链路状态和距离矢量算法）

## 4.1概述

![image-20220107162520980](https://minyeon.oss-cn-beijing.aliyuncs.com/tenglingImg/image-20220107162520980.png)

假设H1正在向H2发送信息， H1中的网络层取得来自于H1运输层的报文段，将每个报文段封装成一个数据报，然后将数据报向相邻路由器R1发送。在接收方主机H2，网络层接收来自相邻路由器R2的数据报，提取出运输层报文段，并将其向上交付给H2的运输层

路由器的主要作用便是将数据报从入链路发到出链路



### 4.1 转发和路由选择

转发：当一个分组到达路由器的一条输入链路时，路由器必须将该分组移动到适当的输出链路

路由选择：当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或路径。 会涉及到路由选择算法

转发与路由选择的区别：

转发是一个路由器本地动作

路由选择是指网络范围的过程，以决定分组从源到目的地所采取的端到端路径

每台路由器具有一张转发表。路由器通过检查到达分组首部字段的值来转发分组。然后使用该值在该路由器的转发表中索引查询。





![image-20220107170551024](https://minyeon.oss-cn-beijing.aliyuncs.com/tenglingImg/image-20220107170551024.png)

## 虚电路和数据报网络

网络层也为能够在两台主机之间提供无连接服务或连接服务

- 网络层连接与无连接服务与运输层面向连接和无连接服务的重大差异:
- 网络层是主机到主机，运输层是进程到进程
- 网络层提供无连接服务或者连接服务器，不同时提供，无连接服务器为虚电路，连接服务为数据网络

### 虚电路网络

许多网络体系结构是虚电路网络，网络层使用连接被称为虚电路

虚电路组成：源和目的主机之间的路径， 指定接收方地址，等待网络建立虚电路，网络层觉得发送方与接收方之间的路径，即该虚电路的所有分组要通过一系列链路与路由器。网络层也为沿着该路径的每条链路觉得一个VC号。最后网络层在沿着路径的每台路由器的转发表中增加一个表项。在虚电路建立期间，网络层还可以预留该虚电路路径上的资源。

 VC号，沿着该路径的每段链路的一个号码

沿着该路径的每台路由器中的转发表表项

![image-20220117111640156](https://minyeon.oss-cn-beijing.aliyuncs.com/tenglingImg/image-20220117111640156.png)

网络层虚电路建立与运输层的连接建立区别：

运输层连接建立仅涉及两个端系统，路由器完全不知情

虚电路网络层：沿着系统之间路径上的路由器都要参与虚电路，而且每台路由器完全知道经过它的所有虚电路

### 数据报网络

每当一个端系统要发送分组，它就为该分组加上目的端系统的地址，然后将分组推进网络中。

当分组从源到目的地传输，它通过一系列路由器传递。这些路由器中的每台都使用分组的目的地址来转发该分组。特别是，每台路由器有一个将目的地址映射到链路接口的转发表；当分组到达路由器时，路由器使用该分组的目的地址在转发表中查找适当的输出链路接口。然后路由器有意将分组向该输出链路接口转发

![image-20220117121758783](https://minyeon.oss-cn-beijing.aliyuncs.com/tenglingImg/image-20220117121758783.png)

路由器用分组的目的地址的前缀与该表中的表项进行匹配，如果存在一个匹配项，则路由器向与该匹配项相联系的链路转发组。当有多个匹配时，该路由器使用最长前缀匹配规则。可能无序到达

### 路由器工作原理

转发功能：实际将分组从一台路由器的入链路传送到适当的出链路



![image-20220118142344460](https://minyeon.oss-cn-beijing.aliyuncs.com/tenglingImg/image-20220118142344460.png)

1. 输入端口:将一条输入的物理链路与路由器相连接的物理层功能

执行需要与位于入链路远端的数据链路层交互的数据链路层功能，表示在输入与输出端口部分的中间方框中。

2. 交换结构：将路由器的输入端口与输出端口相连接。

3. 输出端口：输出端口存储从交换结构接收的分组，并通过执行必要的链路层和物理层功能在输入链路上传输这些分组。

4. 路由器选择处理器：路由选择处理器执行路由选择协议，维护路由选择表以及连接的链路状态信息，并未路由器计算转发表

### 输入端口

输入端口的线路端接功能与链路层处理实现了用于各个输入链路的物理层和链路层。

<img src="https://minyeon.oss-cn-beijing.aliyuncs.com/tenglingImg/image-20220118154929147.png" alt="image-20220118154929147" style="zoom:67%;" />

路由器是用转发表来查找输出端口，使得到达的分组将能经过交换结构转发到该输出端口。转发表是由路由选择处理器计算和更新的，转发表的副本通常会存放在每个输入端口

查找：只需要搜索转发表查找最长前缀匹配

### 交换结构

分组能从一个输入端口交换到一个输出端口中。交换可以用许多方式完成

经内存交换：由CPU直接控制下完成交换， --输入端口---CPU---输出端口---

经总线交换：经过一根共享总线将分组直接传送到输出端口，不需要路由器选择处理器的干预

经互联网交换
