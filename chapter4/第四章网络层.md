- 怎样实现主机到主机的通信服务的
	- 用于构造网络层分组交付的方法，即数据报模式和虚电路模式
- 网络层的功能
	- 转发功能：涉及分组在单一的路由器中从一条入链路到一条出链路的传送
	- 路由选择功能：一个网络的所有路由器，它们经路由选择协议共同交互，以决定分组从源到目的结点所采用的路径
- 路由选择算法：发送方到接收方的好的路径（链路状态和距离矢量算法）

## 概述

![image-20220107162520980](https://minyeon.oss-cn-beijing.aliyuncs.com/tenglingImg/image-20220107162520980.png)

假设H1正在向H2发送信息， H1中的网络层取得来自于H1运输层的报文段，将每个报文段封装成一个数据报，然后将数据报向相邻路由器R1发送。在接收方主机H2，网络层接收来自相邻路由器R2的数据报，提取出运输层报文段，并将其向上交付给H2的运输层

路由器的主要作用便是将数据报从入链路发到出链路



### 转发和路由选择

转发：当一个分组到达路由器的一条输入链路时，路由器必须将该分组移动到适当的输出链路

路由选择：当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或路径。 会涉及到路由选择算法

转发与路由选择的区别：

转发是一个路由器本地动作

路由选择是指网络范围的过程，以决定分组从源到目的地所采取的端到端路径

每台路由器具有一张转发表。路由器通过检查到达分组首部字段的值来转发分组。然后使用该值在该路由器的转发表中索引查询。存储在转发表项中的该首部的值指出了该分组所属连接的指示，这取决于网络层协议。





![image-20220107170551024](https://minyeon.oss-cn-beijing.aliyuncs.com/tenglingImg/image-20220107170551024.png)

路由器选择算法决定了插入路由器的转发表中的值。 可能是集中式或分布式的

#### 连接建立

某些网络层体系结构如ATM，帧中继，MPLS，要求从源到目的地沿着所选择的路径彼此握手，以便在给定源到目的地连接中的网络层数据分组能够开始流动之前建立起状态。

#### 网络服务模型

定义了分组在发送与接收端系统之间的端到端运输特性

确保交付

具有时延上界的确保交付

有序分组交付

确保最小带宽

确保最大时延抖动

安全性服务



## 网际协议：因特网中的转发和编址

![image-20220122220151802](/Users/jinbo/Library/Application Support/typora-user-images/image-20220122220151802.png)

因特网的网络层有三个主要组件

1. IP协议
2. 路由选择部分
3. 报告数据中的差错和对某些网络信息请求进行响应的设施

### 数据报格式

![image-20220122220844858](/Users/jinbo/Library/Application Support/typora-user-images/image-20220122220844858.png)

- 版本号：4比特规定了数据报的IP协议版本，通过查看版本号，路由器能够确定如何解释IP数据报的剩余部分。
- 首部长度：IPV4数据报可包含一些可变数量的选项，需要这个字段来确定IP数据报中数据部分实际从哪里开始。***一般的IP数据报文具有20个字节***
- 服务类型：包含在IPv4首部中，以便使不同类型的IP数据包能相互区分开
- 数据报长度： IP数据卡报的总长度，以字节计。16Bit，最大长度65535字节
- 标识，标志，片偏移： IP分片有关， IPv6不允许在路由器上对分组分片
- 寿命（TTL）：字段用来确保数据报不会永远在网络中循环，若TTL字段减为0，则数据报必须丢弃
- 协议： IP数据报到达其最终目的地才会有用，该字段值指示了IP数据报的数据部分应交给哪个特点的运输层协议
- 首部校验和： 用于帮助路由器检测收到的IP数据报中的比特错误
- 源和目的IP地址。当某源生成一个数据报时，它在源IP字段中插入它的IP地址，在目的IP地址字段中插入其最终的目的地的地址。

### IP数据报分片

最大传送单元（MTU）：一个链路层帧能传承的最大数据量

片：将IP数据报中的数据分片成两个或更多较小的IP数据报，用单独的链路层帧封装这些较小的IP数据报，然后向输出链路上发送这些帧。每个这些较小的数据报都称为片

片在其到达目的地运输车以前需要重新组装。

主机实现将接受到的片拼接到一起以形成初始的数据报

发送主机在为该数据报设置源和目的地址的同时再贴上**标识号**，发送主机通常将为它发送的每个数据报的标识号加1. 当需要对数据报分片时，形成的每个数据报具有初始数据报的源地址，目的地址与标识号。**最后一个片的标识比特被设为0，而其他的标识比特设为1.**

**偏移字段**指定了该片应该放在初始IP数据报的位置。 为了让目的主机确保是否丢失一个片

在目的地：数据报的有效载荷仅当在IP层已完全重构为初始IP数据报时，才被传递给目的地运输层。

### IPv4编址

IP要求每台主机和路由器接口拥有自己的IP地址。因此，一个IP地址技术上是与一个接口相关联的

互联网三个主机接口与1个路由器接口形成一个子网。IP编制为这个子网分配一个地址 x x x x.xxxx.xxxx.xxxx/xx,其中/xx，被称为子网掩码

#### CIDR

因特网的地址分配策略被称为无类别域间路由选择（CIDR）。分为了2个部分a.b.c.d/x，其中x指示了地址第一部分中的比特数。x最高比特构成了IP地址的网络部分，并且经常被称为该地址的前缀。

一个地址的剩余32-x比特可认为是用于区分该组织内部设备的，其中的所有设备具有相同的网络前缀

#### 分类编制

A （8）B（16） C（24）

广播地址：255.255.255.255。当一太主机发出一个目的地址为255.255.255.255的数据报时，该报文会交付给同一个网络中的所有主机。路由器也会有选择地向邻近的子网转发该报文

  ### 获取主机地址：动态主机配置协议（DHCP）

DHCP允许主机自动获取一个IP地址。 由于DHCP具有能将主机连接进一个网络的网络相关方面的自动能力，故它又常被称为即插即用协议。

对于一台新到达的主机而言，DHCP协议是一个4个步骤的过程，

![image-20220122233836041](/Users/jinbo/Library/Application Support/typora-user-images/image-20220122233836041.png)

1. DHCP服务器发现： 一台新到的主机的首要任务是发现一个要与交互的DHCP服务器。通过使用一个DH CP发现报文来完成。DHCP客户生产包含DHCP发现报文的IP数据报，其中使用广播地址255.255.255.255，并且使用“本主机”源地址0.0.0.0.
2. DHCP服务器提供 DHCP服务器收到一个DHCP发现报文时，用一个DHCP提供报文向客户作出响应。
3. 新到达的客户从一个或多个服务器提供中选择一个，并向选中的服务器提供一个DHCP请求报文进行响应，回显配置参数
4. DHCP A CK，服务器用DHCP ACK 报文对DHCP请求报文进行响应，证实所要参数

### 网络地址转换

当向或从全球因特网发送或接收分组，地址在何处才必须是唯一的呢？答案在与NAT

NAT路由器上的一张NAT转换表，包含了端口机器IP地址

NAT对P2P程序非常不利，而UPn P是P2P应用程序的救世主

### 因特网控制报文协议

被主机和路由器用来彼此沟通网络层的信息

- 最典型的用途是差错报告

被认为是IP的一部分，但从体系结构上来讲它是位于IP之上的。因为ICMP报文是承载在IP分组中的。

- ICMP报文是源抑制报文

执行拥塞控制

## IPV6

32比特的IP地址空间即将用尽。为了应对这种大IP地址空间大需求，开发了一种新的IP协议，即IPV6

![image-20220123115420860](https://minyeon.oss-cn-beijing.aliyuncs.com/tenglingImg/image-20220123115420860.png)

### 与IPV4的不同

- 扩大的地址容量。从32Bit增加到128Bit。 IPV6还引入了一种称为任播地址的新型地址，这种地址可以使数据报交付给一组主机中的任意一个。

- 简化高效的40字节首部。 

- 流标签与优先级 。 流定义：给属于特殊流的分组加上标签，这些特殊流是发送方要求进行特殊处理的流，如一种非默认服务质量或需要实时服务的流

  

### 字段定义

- 版本：用于标识IP版本号 IPv6将字段值设为6
- 流量类型：该8比特字段与我们在IPv4中看到的TOS字段的含义相似。
- 流标签： 该20比特的字段用于标识一条数据报的流
- 有效载荷长度： 该16比特值作为一个无符号整数，给出了IPv6数据报中跟在定长的40字节数据报首部后面的字节数量。
- 下一个首部。 
- 跳限制
- 源地址和目的地址
- 数据  Ipv6数据报的有效载荷部分

IPv6不允许在中间路由器上进行分片与重新组装，只能在源与目的地上执行。如果路由器收到的数据报太大，只需要丢弃数据报，并向发送方发回一个“分组太大”的ICMP

没有首部校验和，因为运输层和链路层执行了校验操作，快速处理IP分组是关注的重点

IPv4选项可能出现在IPv6首部中由“下一个首部：指出的位置上



## 路由选择算法

主机通常直接与一台路由器相连接，该路由器即为该主机的默认路由器又称为该主机的第一跳路由器。也将默认路由器称做源路由器，把目的主机的默认路由器称作目的路由器。

路由选择算法的目的是简单的：给定一组路由器以及连接路由器的链路，路由选择算法要找到一条从源路由器到目的路由器的“好”路径。

### 广义分类方式

#### 根据算法是全局式的还是分散式

##### 全局式路由选择算法

以所有结点之间的连通性及所有链路的费用为输入。也被称作链路状态算法。因为该算法必须知道网络中每条链路的费用。

##### 分散式路由选择算法

以迭代，分布式的方式计算出最低费用路径。一个结点逐渐计算出到达某目的结点或一组目的结点的最低费用路径。

#### 根据算法是静态的还是动态的

静态路由选择算法的变化是非常缓慢的，通常是人工干预进行调整。

动态路由选择算法能够当网络流量负载或拓扑发生变化时改变路由选择路径。更容易受诸如路由选择循环，路由震荡之类问题的影响

### 负载敏感的还是负载迟顿的进行划分

负载敏感算法中，链路费用会动态地变化以反映出底层链路的当前用塞水平

负载迟顿：某条链路的费用不明显地反映当前的用塞水平

###  链路状态路由选择算法

网络拓扑和所有的链路费用都是已知的

链路状态广播，结点广播的结果是所有结点具有了该网络的等同，完整的视图。全局

Dijkstra算法 迭代算法

计算从某结点到网路中所有其他结点的最低费用路径

该全局路由选择算法由一个初始化步骤和其他的循环组成。循环执行的次数与网络中结点个数相同。一旦终止，该算法就计算出了从源结点U到网络中每个其他结点的最短路径。

### 距离向量路由选择算法

距离向量是一种迭代的，异步的和分布式的算法

分布式：每个结点都要从一个或多个直接相连邻居接收某些信息，执行计算，然后将其计算结果分发给邻居

迭代的：此过程一直要持续到邻居之间无更多信息要交换位置

异步：他不要求所有结点相互之间步伐一致地操作。

存在于最低费用路径的费用之间的一种重要关系

![image-20220124155847157](https://minyeon.oss-cn-beijing.aliyuncs.com/tenglingImg/image-20220124155847157.png)

1.距离向量算法：链路费用改变与链路故障

当一个运行DV算反的结点检测到从它自己到邻居的链路费用发送变化时，他就更新其距离向量，并且如果最低费用路径的费用发送了变化，想邻居通知其新的距离向量

2。距离向量算法：增加毒性逆转

## 因特网中的路由选择

### 因特网中自治系统内部的路由选择：RIP

